<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Part 2: Implementing a PI Controller with an Arduino</title>
  <link rel="stylesheet" href="https://moorepants.github.io/eme185/2019/theme/css/main.css" />
  <link rel="stylesheet" href="https://moorepants.github.io/eme185/2019/theme/css/custom.css" />

  <!--[if IE]>
      <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <script type="text/javascript"
    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
</head>

<body id="index" class="home">
  <header id="banner" class="body">
    <h1><a href="https://moorepants.github.io/eme185/2019/">EME 185: Mechanical Systems Design Project </a></h1>
    <nav><ul>
        <li><a href="/eme185/2019">Syllabus</a></li>
        <li><a href="/eme185/2019/pages/schedule.html">Schedule</a></li>
        <li><a href="/eme185/2019/pages/assignments.html">Assignments</a></li>
        <li><a href="https://www.moorepants.info/jkm/courses/eme185-2019/pages/projects.html">Projects</a></li>
        <li><a href="/eme185/2019/pages/resources.html">Resources</a></li>
    </ul></nav>
  </header><!-- /#banner -->
<section id="content" class="body">
    <h1 class="entry-title">Part 2: Implementing a PI Controller with an Arduino</h1>
    
    <div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id2">Introduction</a></li>
<li><a class="reference internal" href="#learning-objectives" id="id3">Learning Objectives</a></li>
<li><a class="reference internal" href="#introduction-to-the-arduino-ide-and-setup-10-minutes" id="id4">Introduction to the Arduino IDE and Setup (10 minutes)</a></li>
<li><a class="reference internal" href="#the-kit-components" id="id5">The Kit Components</a><ul>
<li><a class="reference internal" href="#arduino-uno-microcontroller" id="id6">Arduino Uno Microcontroller</a></li>
<li><a class="reference internal" href="#basic-circuit-modules" id="id7">Basic circuit modules</a></li>
<li><a class="reference internal" href="#light-emitting-diodes-led" id="id8">Light Emitting Diodes (LED)</a><ul>
<li><a class="reference internal" href="#exercise-1-vary-the-led-brightness-15-minutes" id="id9">Exercise 1: Vary the LED Brightness (15 minutes)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#photocells" id="id10">Photocells</a><ul>
<li><a class="reference internal" href="#exercise-2-read-from-the-photocell-15-minutes" id="id11">Exercise 2: Read from the Photocell (15 minutes)</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#control-system" id="id12">Control System</a><ul>
<li><a class="reference internal" href="#circuit-construction" id="id13">Circuit Construction</a></li>
<li><a class="reference internal" href="#implementing-the-controller" id="id14">Implementing the Controller</a><ul>
<li><a class="reference internal" href="#excercise-3-finding-a-setpoint-5-minutes" id="id15">Excercise 3: Finding a Setpoint (5 minutes)</a></li>
<li><a class="reference internal" href="#exercise-4-implement-a-proportional-controller-15-minutes" id="id16">Exercise 4: Implement a Proportional Controller (15 minutes)</a></li>
<li><a class="reference internal" href="#exercise-5-adding-integral-control-15-minutes" id="id17">Exercise 5: Adding Integral Control (15 minutes)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2>Introduction<a class="toc-backref headerlink" href="#id2">¶</a></h2>
<p>This lesson will walk through using an Arduino to control local brightness in a small volume
using a light-emitting diode (LED) as an &quot;actuator&quot; and a photocell as a sensor.</p>
</div>
<div class="section" id="learning-objectives">
<h2>Learning Objectives<a class="toc-backref headerlink" href="#id3">¶</a></h2>
<p>Students will be able to</p>
<ul class="simple">
<li>identify a light emitting diode (LED), understand its function, and connect
it into a circuit</li>
<li>use pulse-width modulation (PWM) to mimic analog output for actuation</li>
<li>identify a photocell, understand its function, and connect it into a
circuit</li>
<li>use a voltage divider to sense change in resistance of a photocell</li>
<li>implement and tune a proportional-integral controller on a
microcontroller</li>
<li>write a program to integrate all of this information</li>
</ul>
</div>
<div class="section" id="introduction-to-the-arduino-ide-and-setup-10-minutes">
<h2>Introduction to the Arduino IDE and Setup (10 minutes)<a class="toc-backref headerlink" href="#id4">¶</a></h2>
<p>Interactive demo of main IDE features:</p>
<ul class="simple">
<li>Code editor</li>
<li>Verify sketch (blank)</li>
<li>Board selection</li>
<li>Port selection</li>
<li>Upload sketch (blank)</li>
<li>Serial monitor/plotter</li>
</ul>
<p>For more in-depth descriptions of the IDE, see the <a class="reference external" href="https://www.arduino.cc/en/Guide/Environment">official guide</a></p>
</div>
<div class="section" id="the-kit-components">
<h2>The Kit Components<a class="toc-backref headerlink" href="#id5">¶</a></h2>
<p>Check the kit that you received and make sure that it has below components.
Our final circuit requires:</p>
<ul class="simple">
<li>Arduino Uno Micro Controller with USB cable</li>
<li>Small Breadboard</li>
<li>an LED</li>
<li>a photocell (photoresistor, light-dependent resistor)</li>
<li>4-8 jumper wires</li>
<li>a 4.7kΩ resistor (yellow, purple, red, [gold])</li>
<li>a 330Ω resistor (orange, orange, brown, [gold])</li>
</ul>
<p>If you are missing any component or you find out that they are not working, let us know.</p>
<div class="section" id="arduino-uno-microcontroller">
<h3>Arduino Uno Microcontroller<a class="toc-backref headerlink" href="#id6">¶</a></h3>
<p>The basics of the Arduino microcontroller were discussed in the part 1 lecture.
The Arduino requires a power source to work and the USB cable offers a way to
both supply power and upload code into its memory simultaneously. For an actual
application, standard practice is to upload and test your code with the USB
first and then use a dedicated power supply to power the Arduino via power jack
(large round socket in black).</p>
<p><img alt="Arduino-uno-Pin-summary" src="https://moorepants.github.io/eme185/2019/images/microcontroller-tutorial/Arduino-uno-Pin-summary.jpg" style="width: 7in;" /></p>
</div>
<div class="section" id="basic-circuit-modules">
<h3>Basic circuit modules<a class="toc-backref headerlink" href="#id7">¶</a></h3>
<p>Analog circuits are circuits dealing with signals free to vary from zero to
full power supply voltage. This stands in contrast to digital circuits, which
almost exclusively employ “all or nothing” signals: voltages restricted to
values of zero and full supply voltage, with no valid state in between those
extreme limits.</p>
</div>
<div class="section" id="light-emitting-diodes-led">
<h3>Light Emitting Diodes (LED)<a class="toc-backref headerlink" href="#id8">¶</a></h3>
<p>Light emitting diodes (LEDs) are semiconductor devices that emit light
when voltage is applied across them. LEDs typically have a fixed voltage
drop of around 2V (depends on the LED), which is the voltage required to cause
it to illuminate. The brightness can then be controlled directly by varying the
current going through the device. In most applications (e.g. indicators),
a current-limiting resistor is connected in series with the LED to provide
a fixed brightness for a given control voltage.</p>
<p><img alt="led" src="https://moorepants.github.io/eme185/2019/images/microcontroller-tutorial/led.jpg" style="width: 3in;" /></p>
<p><object data="https://moorepants.github.io/eme185/2019/images/microcontroller-tutorial/led-diagram.svg" style="width: 3in;" type="image/svg+xml">led-diagram</object></p>
<p>In our application, we will use a fixed current-limiting resistor of 330Ω and
a 5V control voltage, but we will use a technique called pulsewidth modulation
(PWM) to effectively vary the current passing through the circuit.</p>
<p>PWM works by rapidly toggling a digital output between its high (e.g. 5V) and
low (e.g. 0V) values, with varying durations of on and off time. The ratio of
the on time to the total period of the PWM signal is referred to as duty cycle,
and is expressed as a percentage. The logic behind this is: if you were to
integrate the voltage over one period of the PWM signal, the effective voltage
would be the duty cycle times the &quot;on&quot; voltage level. If the switching is fast
enough, many sensors (including our own eyes) will not be able to detect that
the actuator (e.g. an LED) is actually turning on and off, but instead it will
detect an intermediate output roughly corresponding to the equivalent
voltage level. For mechanical systems, such as DC motors, the mechanical
dynamics are often slow enough with respect to the PWM signal that their output
will actually smoothly vary.</p>
<p>The Arduino Uno allows us to output a PWM signal on several of its pins. This
is done by setting the pin as an output, and using the <a class="reference external" href="https://www.arduino.cc/en/Reference/AnalogWrite">analogWrite</a> function.
This function accepts an unsigned (positive) 8-bit integer value ((2^8)-1) between 0 (pin fully off, 0% duty
cycle) and 255 (pin fully on, 100% duty cycle).</p>
<p><object data="https://moorepants.github.io/eme185/2019/images/microcontroller-tutorial/pwm.svg" style="width: 5in;" type="image/svg+xml">pwm</object></p>
<div class="section" id="exercise-1-vary-the-led-brightness-15-minutes">
<h4>Exercise 1: Vary the LED Brightness (15 minutes)<a class="toc-backref headerlink" href="#id9">¶</a></h4>
<ol class="arabic simple">
<li>Start by connecting the 5V pin output and GND pin of the Arduino to the red and blue
&quot;power rails&quot; of your breadboard. This is good practice while using a breadboard.</li>
<li>LEDs are directional components, so ensure that the cathode is connected to
ground (see diagram below). Connect the 330Ω resistor to the other lead, and
connect the resistor to pin 5 of the Arduino using a jumper wire.</li>
<li>Check your circuit against the diagram below. Leave the circuit constructed
throughout the session.</li>
</ol>
<p><object data="https://moorepants.github.io/eme185/2019/images/microcontroller-tutorial/led-circuit.svg" style="width: 3in;" type="image/svg+xml">led-circuit</object></p>
<ol class="arabic simple" start="4">
<li>With this circuit hooked up, you can test its operation. Add to the code
below to repeatedly ramp up the brightness of LED from off to fully on over
a few seconds each time. You'll need the <a class="reference external" href="https://www.arduino.cc/en/Reference/AnalogWrite">analogWrite</a> function as well as
the <a class="reference external" href="https://www.arduino.cc/en/Reference/Delay">delay</a> function. HINT: you can also use a '<a class="reference external" href="https://www.arduino.cc/reference/en/language/structure/control-structure/for/">for</a>' loop to vary the input to the analogWrite function smoothly.
Note that the pin number for the LED has been specified
via a <a class="reference external" href="https://en.wikipedia.org/wiki/C_preprocessor">preprocessor macro</a>.
This is a special statement that literally substitutes each occurence of
<code>LED_PIN</code> with the value 5, saving some of the limited memory in the
microcontroller.</li>
</ol>
<pre class="code c++ literal-block">
<span class="cp">#define LED_PIN 5
</span>
<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">LED_PIN</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// add code here
</span><span class="p">}</span>
</pre>
</div>
</div>
<div class="section" id="photocells">
<h3>Photocells<a class="toc-backref headerlink" href="#id10">¶</a></h3>
<p>Photocells are passive circuit elements which change their resistance in
response to a change in brightness. Their resistance <em>decreases</em> when the
ambient environment becomes <em>brighter</em>. The <a class="reference external" href="https://media.digikey.com/pdf/Data%20Sheets/Photonic%20Detetectors%20Inc%20PDFs/PDV-P7002.pdf">datasheet</a>
for our photocell provides an approximate relationship between resistance and
the illuminance hitting the sensor:</p>
<p><img alt="photocell" src="https://moorepants.github.io/eme185/2019/images/microcontroller-tutorial/photocell.jpg" style="height: 2.5in;" />
<img alt="photocell-resistance" src="https://moorepants.github.io/eme185/2019/images/microcontroller-tutorial/photocell-resistance.png" style="height: 2.5in;" /></p>
<p>An Arduino can sense voltages from 0V to 5V through the analog input pins, but
it has no direct way of sensing resistance. Since our sensor operates by
changing resistance, we need to convert this to a change in voltage. This is
achieved through a voltage divider circuit.</p>
<p><object data="https://moorepants.github.io/eme185/2019/images/microcontroller-tutorial/photocell-circuit.svg" style="width: 3in;" type="image/svg+xml">photocell-circuit</object></p>
<p>In this circuit, we supply 5V from the Arduino as <span class="math">\(V_{\text{in}}\)</span> and
measure <span class="math">\(V_{\text{out}}\)</span> with one of the Arduino's analog input pins (pin
A0). The output voltage for this voltage divider is given by</p>
<div class="math">
\begin{equation*}
V_{\text{out}} = \frac{R}{R + \ R_{s}}V_{\text{in}}
\end{equation*}
</div>
<p>When the brightness increases, the photocell resistance <span class="math">\(R_s\)</span> decreases,
so the output voltage <span class="math">\(V_{\text{out}}\)</span> increases. In our example, we will
simply convert the value read in by <a class="reference external" href="https://www.arduino.cc/en/Reference/AnalogRead">analogRead</a> to a voltage and use it as
a substitute for &quot;brightness&quot;. The input comes in the form of a <strong>10-bit
unsigned integer</strong>, so it has the range of 0 to 1023 (<span class="math">\(2^{10}
- 1 = 1023\)</span>), corresponding to 0V up to 5V, respectively. If we read a value of
<span class="math">\(x\)</span>, we can map this value to a voltage as follows:</p>
<div class="math">
\begin{equation*}
V = \frac{5}{1023}x
\end{equation*}
</div>
<div class="section" id="exercise-2-read-from-the-photocell-15-minutes">
<h4>Exercise 2: Read from the Photocell (15 minutes)<a class="toc-backref headerlink" href="#id11">¶</a></h4>
<ol class="arabic simple">
<li>Leave the 5V and GND connections from the LED example intact, then place one
of the photocell leads on the 5V rail. A photocell is essentially
a resistor, so its orientation in the circuit doesn't matter.</li>
<li>Bend the photocell's leads to 90° so that it faces the LED.</li>
<li>Connect the other lead of the photocell to the 4.7kΩ resistor which goes to
GND.</li>
<li>Use a jumper wire to connect the junction between the photocell and the
4.7kΩ resistor to the Arduino's A0 pin.</li>
<li>Check your circuit against the diagram above.</li>
<li>Create a new sketch using the Arduino IDE and replace it with the following
code. Write your own statements to read in the input value (10-bit unsigned
int), cast (convert) that reading to a floating point value, convert the brightness value into voltage using the formula above
then print the voltage to the serial port. You will need to make use of the
<a class="reference external" href="https://www.arduino.cc/en/Reference/AnalogRead">analogRead</a> and <a class="reference external" href="https://www.arduino.cc/en/Serial/Println">Serial.println</a> functions.</li>
</ol>
<pre class="code c++ literal-block">
<span class="cp">#define SENSOR_PIN A0
</span>
<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">SENSOR_PIN</span><span class="p">,</span> <span class="n">INPUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// add code here
</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
<span class="p">}</span>
</pre>
<ol class="arabic simple" start="7">
<li>Once the code is uploaded and running, use the Arduino IDE's <strong>serial
monitor</strong> or <strong>serial plotter</strong> to view the values being read. <em>What happens
to the voltage if you cast shadows over the circuit?</em></li>
<li>Allow the voltage to settle to a steady value. Use the serial monitor to
record the numerical value.  This voltage corresponds to the ambient brightness in the room.</li>
</ol>
</div>
</div>
</div>
<div class="section" id="control-system">
<h2>Control System<a class="toc-backref headerlink" href="#id12">¶</a></h2>
<p>Now we'll put the LED and photocell together in order to obtain a desired
brightness level. Here is a block diagram of the control system we will
implement to achieve this:</p>
<p><object data="https://moorepants.github.io/eme185/2019/images/microcontroller-tutorial/controller.svg" style="width: 7in;" type="image/svg+xml">controller</object></p>
<p>In this controller example, we will use voltage as a representation of
brightness. Because of the voltage divider configuration, the voltage read by
the Arduino's input pin will vary proportionally to the brightness sensed by
the photocell.</p>
<p>The measured voltage is compared to a voltage representing the desired
brightness, resulting in some error. This error is then fed into a controller,
which transforms the error into a PWM signal to change the LED brightness. For
example, if the measured brightness is lower than desired, the error will be
positive, and the controller coefficients will produce a positive PWM signal to
drive the LED to become brighter. This has the effect of increasing the
measured voltage, hence decreasing the error. This kind of controller
configuration is called a regulator, and its job is to achieve and maintain
zero error between the measured output and the desired output.</p>
<div class="section" id="circuit-construction">
<h3>Circuit Construction<a class="toc-backref headerlink" href="#id13">¶</a></h3>
<p>Now let's put together the hardware of our control system. The photocell will be the sensor
and the led will be the actuator that we control. Our goal is to control the local brightness
of small volume surrounding our sensor.</p>
<p>The circuit consists of a light emitting diode (LED) circuit, driven by one of
the Arduino's digital I/O pins capable of producing a pulsewidth modulation
(PWM) signal. This will allow the LED’s brightness to change. A photocell
facing the LED senses the ambient lighting. The objective of the circuit is to
demonstrate an automatic feedback control system that drives the LED to
a desired brightness level near the sensor. You will be able to cast shadows on
the photocell and watch as the LED brightness increases to compensate for the
dimmed lighting.</p>
<p>Both components (the LED and the photocell) should be connected from the previous
two sections. The most important part of the control circuit construction
(aside from making the correct electrical connections) is that the LED and
photocell are close to and facing one another. This will ensure that the LED is
able to influence the reading of the sensor as much as possible.</p>
<p>Once constructed, the circuit should look like the image below:</p>
<p><img alt="complete-circuit" src="https://moorepants.github.io/eme185/2019/images/microcontroller-tutorial/complete-circuit.jpg" style="width: 5in;" /></p>
</div>
<div class="section" id="implementing-the-controller">
<h3>Implementing the Controller<a class="toc-backref headerlink" href="#id14">¶</a></h3>
<div class="section" id="excercise-3-finding-a-setpoint-5-minutes">
<h4>Excercise 3: Finding a Setpoint (5 minutes)<a class="toc-backref headerlink" href="#id15">¶</a></h4>
<ol class="arabic simple">
<li>Start with the photocell reading code you finished.</li>
<li>Add to that sketch the code for setting up the LED (refer to the first code
listing for help), then use the <a class="reference external" href="https://www.arduino.cc/en/Reference/AnalogWrite">analogWrite</a> function inside <code>setup</code>
to turn the LED on at <strong>30% duty cycle</strong>.</li>
<li>Run the sketch and observe the voltage output by the photocell circuit.
<strong>Write this value down</strong> as this will be the desired brightness level we
will seek to achieve with an automatic control system.</li>
</ol>
</div>
<div class="section" id="exercise-4-implement-a-proportional-controller-15-minutes">
<h4>Exercise 4: Implement a Proportional Controller (15 minutes)<a class="toc-backref headerlink" href="#id16">¶</a></h4>
<ol class="arabic simple">
<li>Create a new sketch based on the code below. You will need to replace the
value of <code>r</code> with the setpoint you found in the previous exercise, and
you will have to implement the controller equations inside <code>loop</code> to
find <code>y</code>, <code>e</code>, and <code>u</code>. For now, leave <span class="math">\(K_{p} = 0\)</span>
and use <span class="math">\(u(t) = K_p e(t)\)</span>.</li>
</ol>
<pre class="code c++ literal-block">
<span class="cp">#define SENSOR_PIN A0
#define LED_PIN 5
</span>
<span class="c1">// desired voltage (change this to the value you found)
</span><span class="kt">float</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="c1">// proportional controller coefficient (change to tune controller)
</span><span class="kt">float</span> <span class="n">Kp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// Initialize Global variables
// reading from the photocell
</span><span class="kt">float</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">// error between the desired output and the reading
</span><span class="kt">float</span> <span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">// output to send to the LED
</span><span class="kt">float</span> <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">SENSOR_PIN</span><span class="p">,</span> <span class="n">INPUT</span><span class="p">);</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">LED_PIN</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>


    <span class="c1">// store your measured voltage in this variable
</span>    <span class="n">y</span> <span class="o">=</span>

    <span class="c1">// compute the error between the measurement and the desired value
</span>    <span class="n">e</span> <span class="o">=</span>

    <span class="c1">// compute the control effort by multiplying the error by Kp
</span>    <span class="n">u</span> <span class="o">=</span>

    <span class="c1">// make sure the output value is bounded to 0 to 255 using the bound function defined below
</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">bound</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">analogWrite</span><span class="p">(</span><span class="n">LED_PIN</span><span class="p">,</span> <span class="n">u</span><span class="p">);</span> <span class="c1">// then write it to the LED pin to change control voltage to LED
</span>
    <span class="c1">// plot the measurement
</span>    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">'\t'</span><span class="p">);</span>
    <span class="c1">// plot the desired output
</span>    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">'\t'</span><span class="p">);</span>
    <span class="c1">// plot the error
</span>    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>

    <span class="n">delay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Bound the input value between x_min and x_max.
</span><span class="kt">float</span> <span class="nf">bound</span><span class="p">(</span><span class="kt">float</span> <span class="n">x</span><span class="p">,</span> <span class="kt">float</span> <span class="n">x_min</span><span class="p">,</span> <span class="kt">float</span> <span class="n">x_max</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">x_min</span><span class="p">)</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x_min</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">x_max</span><span class="p">)</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x_max</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
</pre>
<ol class="arabic simple" start="2">
<li>Once the code is uploaded and running, open up the serial plotter. The
series of <a class="reference external" href="https://www.arduino.cc/en/Serial/Print">Serial.print</a> statements in the code plots the measurement signal
<span class="math">\(y(t)\)</span>, the reference signal <span class="math">\(r(t)\)</span> (constant), and the error
signal <span class="math">\(e(t)\)</span>. Perturb the brightness reading of the photocell by
casting shadows on it and figure out which line is which.</li>
<li>Let the signals become steady, then use the error measurement to make an
estimate of what <span class="math">\(K_{p}\)</span> should be to drive the error to zero. Recall
that the reference value was found by producing a PWM signal at 30% duty
cycle, so the term <span class="math">\(u(t) = K_{p}e(t)\)</span> should be approximately
<span class="math">\(0.3 \times 255 = 76.5\)</span>. If <span class="math">\(u(t)\)</span> should be 76.5, what should <span class="math">\(K_{p}\)</span> be?
This initial guess will likely produce a proportional constant that is too high and causes instability.
Divide it by 2 to start and try different values. Note the steady state error.</li>
<li>Now try casting shadows over the circuit. Looking at the LED itself, does it
seem to compensate when less light from the ambient environment hits the
photocell? What do you observe when looking at the error signal in the
serial plotter?</li>
</ol>
</div>
<div class="section" id="exercise-5-adding-integral-control-15-minutes">
<h4>Exercise 5: Adding Integral Control (15 minutes)<a class="toc-backref headerlink" href="#id17">¶</a></h4>
<p>As you probably have noticed, proportional controllers may suffer from non-zero
<em>steady state error</em>. That is, there is a consistent mismatch between the
desired and measured outputs, but the controller does not compensate for it
exactly. To fix this problem, we can implement an integral control component,
which adds to the controller output a multiple of the total integral of the
error over all time. If a small but steady error is present, the integral of
this error over time will become large, and the integral component of the
controller will increase the total controller output to drive the error down to
zero.</p>
<ol class="arabic simple">
<li>Starting with the code you wrote to implement the proportional controller,
introduce a global variable <span class="math">\(K_{i}\)</span> and set it to an order of
magnitude smaller than <span class="math">\(K_{p}\)</span>.</li>
<li>Introduce a variable to keep track of the total accumulation of error. Each
time the error is calculated, add it to the current value of the error
accumulator variable.</li>
<li>Modify the line that computes the PWM control value to use the full control
equation:</li>
</ol>
<div class="math">
\begin{equation*}
u(t) = K_{p}e(t) + K_{i}\sum_{\tau=0}^{t}e(\tau)
\end{equation*}
</div>
<ol class="arabic simple" start="4">
<li>Upload the sketch and open the serial plotter. <em>What happens if you cast
shadows on the circuit now?</em></li>
<li>Play around with <span class="math">\(K_p\)</span> and <span class="math">\(K_i\)</span>. What does increasing or
decreasing these coefficients do? Compare your observations to some of the
information on Wikipedia's extensive article on <a class="reference external" href="https://en.wikipedia.org/wiki/PID_controller">PID control</a></li>
</ol>
</div>
</div>
</div><script type='text/javascript'>if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        fonts: [['STIX', 'TeX']]," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
</section>
  <section id="extras" class="body">
  </section><!-- /#extras -->
  <footer id="contentinfo" class="body">
    <address id="about" class="vcard body">
    <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
      <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
    </a>
    <br />
    This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
    <br />
    <br />
    Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
    <p>The source for the website is <a
        href="https://github.com/moorepants/eme185">hosted on
        Github</a>. Report issues
      and make contributions there.</p>
    </address><!-- /#about -->
  </footer><!-- /#contentinfo -->

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-15966419-8', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html>